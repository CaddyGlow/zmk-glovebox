keyboard: "corne"
description: "Corne (CRKBD) 42-key split keyboard"
vendor: "foostan"
key_count: 42

# Compile method configurations
compile_methods:
  # Dynamic ZMK Config generation - generates workspace on-the-fly
  - method_type: generic_docker
    image: zmkfirmware/zmk-build-arm:stable
    build_strategy: zmk_config
    cache_workspace: true
    zmk_config_repo:
      # Leave config_repo_url empty to enable dynamic generation
      config_repo_url: ""
      config_repo_revision: "dynamic"
      workspace_path: "~/.glovebox/dynamic-zmk-config/corne"
      config_path: "config"
      build_yaml_path: "build.yaml"
      west_commands:
        - "west init -l config"
        - "west update"
    build_commands: [] # Commands auto-generated from build.yaml
    environment_template:
      ZEPHYR_TOOLCHAIN_VARIANT: "zephyr"
      ZEPHYR_SDK_INSTALL_DIR: "/opt/zephyr-sdk"
    volume_templates: [] # Volume mappings auto-generated
    fallback_methods: ["west"]

  # Fallback to traditional ZMK west workspace
  - method_type: generic_docker
    image: zmkfirmware/zmk-build-arm:stable
    build_strategy: west
    board_targets: ["nice_nano_v2"]
    cache_workspace: true
    west_workspace:
      manifest_url: "https://github.com/zmkfirmware/zmk.git"
      manifest_revision: "main"
      modules: []
      west_commands:
        - "west init -m https://github.com/zmkfirmware/zmk.git --mr main"
        - "west update"
      workspace_path: "~/.zmk-workspace"
      config_path: "config"
    build_commands:
      - "west build -d build/left -s app -b nice_nano_v2 -- -DSHIELD=corne_left -DZMK_CONFIG=/zmk-workspace/config"
      - "west build -d build/right -s app -b nice_nano_v2 -- -DSHIELD=corne_right -DZMK_CONFIG=/zmk-workspace/config"
    environment_template:
      ZEPHYR_TOOLCHAIN_VARIANT: "zephyr"
      ZEPHYR_SDK_INSTALL_DIR: "/opt/zephyr-sdk"
    volume_templates:
      - "~/.zmk-workspace/config:/workspace/config:rw"
      - "~/.zmk-workspace/.west:/workspace/.west:rw"
    fallback_methods: ["local"]

# Flash method configurations
flash_methods:
  - method_type: usb
    device_query: "vendor=Adafruit and serial~=QTPY-.* and removable=true"
    mount_timeout: 30
    copy_timeout: 60
    sync_after_copy: true
    fallback_methods: ["dfu"]
  - method_type: dfu
    vid: "0x1209"
    pid: "0x0001"
    interface: 0
    alt_setting: 0
    timeout: 30
    fallback_methods: []

firmwares:
  main:
    version: "main"
    description: "Latest ZMK firmware main branch"
    build_options:
      repository: "zmkfirmware/zmk"
      branch: "main"

  v3.5:
    version: "v3.5"
    description: "Stable ZMK firmware v3.5"
    build_options:
      repository: "zmkfirmware/zmk"
      branch: "v3.5"

keymap:
  includes:
    - "#include <behaviors.dtsi>"
    - "#include <dt-bindings/zmk/outputs.h>"
    - "#include <dt-bindings/zmk/keys.h>"
    - "#include <dt-bindings/zmk/bt.h>"

  formatting:
    default_key_width: 8
    key_gap: "  "
    base_indent: ""
    rows:
      - [0, 1, 2, 3, 4, 5, -1, -1, -1, -1, -1, -1, 6, 7, 8, 9, 10, 11]
      - [12, 13, 14, 15, 16, 17, -1, -1, -1, -1, -1, -1, 18, 19, 20, 21, 22, 23]
      - [24, 25, 26, 27, 28, 29, -1, -1, -1, -1, -1, -1, 30, 31, 32, 33, 34, 35]
      - [-1, -1, -1, 36, 37, 38, -1, -1, -1, -1, -1, -1, 39, 40, 41, -1, -1, -1]

  kconfig_options:
    DEEP_SLEEP:
      name: "CONFIG_ZMK_SLEEP"
      type: "bool"
      default: false
      description: "Enable deep sleep mode to conserve battery."

    DEEP_SLEEP_TIMEOUT_MS:
      name: "CONFIG_ZMK_IDLE_SLEEP_TIMEOUT"
      type: "int"
      default: 900000
      description: "Milliseconds of inactivity before entering deep sleep."

    COMBO_MAX_PRESSED_COMBOS:
      name: "CONFIG_ZMK_COMBO_MAX_PRESSED_COMBOS"
      type: "int"
      default: 4
      description: "Maximum number of currently pressed combos."

    COMBO_MAX_COMBOS_PER_KEY:
      name: "CONFIG_ZMK_COMBO_MAX_COMBOS_PER_KEY"
      type: "int"
      default: 5
      description: "Maximum number of active combos that use the same key position."

    COMBO_MAX_KEYS_PER_COMBO:
      name: "CONFIG_ZMK_COMBO_MAX_KEYS_PER_COMBO"
      type: "int"
      default: 4
      description: "Maximum number of keys to press to activate a combo."

  # System behaviors for Corne
  system_behaviors:
    - code: "&trans"
      name: "Transparent"
      description: "Pass key through to next layer"
      expected_params: 0
      origin: "zmk"
      params: []

    - code: "&none"
      name: "None"
      description: "Disable key press"
      expected_params: 0
      origin: "zmk"
      params: []

    - code: "&kp"
      name: "Key Press"
      description: "Send a keycode"
      expected_params: 1
      origin: "zmk"
      params:
        - "code"
      includes:
        - "#include <dt-bindings/zmk/keys.h>"

    - code: "&lt"
      name: "Layer Tap"
      description: "Tap for key, hold for layer"
      expected_params: 2
      origin: "zmk"
      params:
        - "layer"
        - "code"

    - code: "&mo"
      name: "Momentary Layer"
      description: "Hold to activate layer"
      expected_params: 1
      origin: "zmk"
      params:
        - "layer"

    - code: "&mt"
      name: "Mod Tap"
      description: "Tap for key, hold for modifier"
      expected_params: 2
      origin: "zmk"
      params:
        - "code"
        - "code"

    - code: "&bt"
      name: "Bluetooth"
      description: "Bluetooth management"
      expected_params: 1
      origin: "zmk"
      params:
        - "command"
      includes:
        - "#include <dt-bindings/zmk/bt.h>"
      commands:
        - code: "BT_CLR"
          description: "Clear bond information for selected profile"
        - code: "BT_CLR_ALL"
          description: "Clear bond information for all profiles"
        - code: "BT_NXT"
          description: "Switch to next profile"
        - code: "BT_PRV"
          description: "Switch to previous profile"
        - code: "BT_SEL"
          description: "Select specific profile"
          flatten: true
          additionalParams:
            - name: "Bluetooth Profile"
              type: "enum"
              values: [0, 1, 2, 3, 4]

    - code: "&out"
      name: "Output Selection"
      description: "Select output (USB/BLE)"
      expected_params: 1
      origin: "zmk"
      params:
        - "command"
      includes:
        - "#include <dt-bindings/zmk/outputs.h>"
      commands:
        - code: "OUT_BLE"
          description: "Prefer Bluetooth output"
        - code: "OUT_USB"
          description: "Prefer USB output"
        - code: "OUT_TOG"
          description: "Toggle between USB and BLE"

  keymap_dtsi: |
    /*
    * Copyright (c) 2020 The ZMK Contributors
    *
    * SPDX-License-Identifier: MIT
    */
    /* THIS FILE WAS GENERATED BY GLOVEBOX
    *
    * This file was generated automatically. You may or may not want to
    * edit it directly.
    */
    /* Include all behavior includes needed */
    {{ resolved_includes }}
    /* Automatically generated layer name #define */
    {{ layer_defines }}
    /* Custom Device-tree */
    {% if custom_devicetree %}
    {{ custom_devicetree }}
    {% endif %}
    /* Input Listeners */
    {# Render generated DTS from inputListeners JSON data #}
    {% if input_listeners_dtsi %}
    {{ input_listeners_dtsi }}
    {% endif %}
    /* System behavior and Macros */
    {# Render content read from system_behaviors.dts #}
    {{ system_behaviors_dts }}
    /* #define for key positions */
    {# Render content read from key_position.h #}
    {{ key_position_header }}
    /* Custom Defined Behaviors */
    / {
    {% if custom_defined_behaviors %}
    {{ custom_defined_behaviors }}
    {% else %}
    {% endif %}
    };
    /* Automatically generated macro definitions */
    / {
        macros {
    {% if user_macros_dtsi %}
    {{ user_macros_dtsi }}
    {% endif %}
        };
    };
    /* Automatically generated behavior definitions */
    / {
        behaviors {
    {% if user_behaviors_dtsi %}
    {{ user_behaviors_dtsi }}
    {% endif %}
        };
    };
    /* Automatically generated combos definitions */
    {% if combos_dtsi -%}
    / {
    {{ combos_dtsi }}
    };
    {% endif %}
    /* Automatically generated keymap */
    / {
    {{ keymap_node }}
    };

  system_behaviors_dts: |
    / {
        behaviors {
        };
    };

  key_position_header: |
    #define POS_L0 0
    #define POS_L1 1
    #define POS_L2 2
    #define POS_L3 3
    #define POS_L4 4
    #define POS_L5 5
    #define POS_L6 12
    #define POS_L7 13
    #define POS_L8 14
    #define POS_L9 15
    #define POS_L10 16
    #define POS_L11 17
    #define POS_L12 24
    #define POS_L13 25
    #define POS_L14 26
    #define POS_L15 27
    #define POS_L16 28
    #define POS_L17 29
    #define POS_L18 36
    #define POS_L19 37
    #define POS_L20 38

    #define POS_R0 6
    #define POS_R1 7
    #define POS_R2 8
    #define POS_R3 9
    #define POS_R4 10
    #define POS_R5 11
    #define POS_R6 18
    #define POS_R7 19
    #define POS_R8 20
    #define POS_R9 21
    #define POS_R10 22
    #define POS_R11 23
    #define POS_R12 30
    #define POS_R13 31
    #define POS_R14 32
    #define POS_R15 33
    #define POS_R16 34
    #define POS_R17 35
    #define POS_R18 39
    #define POS_R19 40
    #define POS_R20 41

